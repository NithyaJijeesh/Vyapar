<!-- create by athul -->
<!--updated by Nithya-->

{% extends 'company/src/html/base.html' %}

{% block content %}
{% load static %}
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.6" integrity="sha384-FhXw7b6AlE/jyjlZH5iHa/tTe9EpJ1Y55RjcgPbjeWMskSxZt1v9qkxLJWNJaGni" crossorigin="anonymous"></script>
<!-- Add the HTMX library script -->
<script src="https://unpkg.com/htmx.org@1.9.6" ></script>

<!-- Load SheetJS from a CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>

{% load my_extras %}
{% load custom_filters %}

<style>
    .bs{
        box-shadow: 2px 2px 10px 3px rgba(0, 0, 0, 0.397);
    }
    .bs_sm{
        box-shadow: inset 2px 2px 5px 3px rgba(0, 0, 0, 0.199);
    }
    .tb{
        color: black;
    }
    .tg{
        color: rgb(0, 140, 7);
    }
    .tr{
        color: rgb(218, 0, 0);
    }
    .btn_add{
        background-color: orange;
        color: black;
    }
    .btn_add:hover{
        background-color: rgb(234, 152, 0);
        color: black;
    }
    ::-webkit-scrollbar{
        display: none
    }
    .bg-pink{
        background-color: rgb(239, 3, 82)
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 3px;
        text-align: center;
        /* border: 1px solid #ddd; */
    }

    th.extra {
        position: relative;
    }

    th.extra span {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
    }
</style>
{% if Party %}


<div class="body-wrapper">
    <br><br><br>
    <div class="row p-0 m-0">
        <div class="col-12  p-0 m-0">
            <div class=" bg-light bg-light bs pb-0 mb-0"style="height:100%;width:100%">
                <div class="d-flex justify-content-center pt-4">
                    <a href=""  id="b1" class="btn  text-white" style="margin-right: 10px; background-color: rgb(252, 3, 3,0.7);border-radius: 20px;box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">Add Sale  <i class="fa fa-plus"></i></a>
                    <a href="" id="b2" class="btn  text-white" style="margin-right: 10px;background-color: rgba(3, 161, 252, 0.7);border-radius: 20px;box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">Add Purchase  <i class="fa fa-plus"></i></a>
                    <a href="" id="b3" class="btn text-primary" style="border-radius: 20px;border: 1px solid rgb(40, 12, 222);background-color: white;box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">Add More  <i class="fa fa-plus"></i></a>
                </div>
                <p></p>
                <hr class="p-0 m-0">
            </div>
        </div>
    </div>
    <br>
    <div class="row ps-3 pe-3 m-0">
        <div class="col-sm-12 col-lg-3  ps-2 pe-3 pb-2" style="height: 50rem;">
            <div class="card bg-light bs"style="height:100%;">
                <div class="row m-0">
                    <div class="col-12 p-4 pt-3" style="z-index:2">
                        <form action="" method="post">
                            {% csrf_token %}
                            <div class="d-flex justify-content-between">
                                <span id="search_item" class="fa fa-search tb bg-info text-light ms-2 mt-1" style="border-radius: 50%;padding: 0.77rem;"></span>
                                <a id="add_party_btn" class="btn btn-sm rounded p-2 mt-1 btn_add" href="{% url 'add_parties' %}"><span class="fa fa-plus"></span> Add Party</a>
                            </div>
                            <div class="position-relative">
                                <div class="position-absolute end-0" style="margin-top:0.5rem;margin-right:0.7rem">
                                    <span hidden id="close_seacrh" class="fa fa-times fs-4 tr"></span>
                              
                                </div>
                            </div>
                        
                            <input hidden id="search_party_input" class="form-control border-dark text-dark" type="text" placeholder="search here.." name="searching_item"/>
                            
                        </form>
                    </div>
                    <div class="ps-3 pe-3">
                        <hr class="p-0 m-0">
                    </div>
                    <div class="col-12 p-3 pt-0">
                        {% if Party %}
                        <div id="item_search_filter_target">
                            <form action="" method="post">
                                {% csrf_token %}
                                <div style="overflow: auto;height: 42rem;">
                                    <table class="table w-100 table-light table-striped table-hover">
                                        <thead class="bg-primary">
                                            <th class="text-start fs-2 tb">PARTY</th>
                                            <th class="text-end fs-2 tb">AMOUNT</th>
                                        </thead>
                                        <tbody>
                                            {% for i in Party %}
                                            <tr class="item_lists_hide">
                                                <td style="cursor:pointer" class="text-start fs-2 fw-bold text-dark">
                                                    <a href="{% url 'view_parties' i.id %}" class="my-3">
                                                        {{ i.party_name|capfirst }}
                                                    </a>
                                                </td>
                                              
                                                <td class="text-end fs-2 fw-bolder" style="color: green;">
                                                    <a href="{% url 'view_parties' i.id %}" class="my-3">
                                                        {% if i.payment == 'To Pay' %}
                                                        <span style="border: none; color: red; ">{{ i.current_balance }}</span>
                                                        {% elif i.payment == 'To Receive' %}
                                                        <span style="border: none; color: green; ">{{ i.current_balance }}</span>
                                                        {% else %}
                                                        <span style="border: none; color: black; ">{{ i.current_balance }}</span>
                                                        {% endif %}
                                                    </a>
                                                    <div class="btn-group mb-1">
                                                        <button style="border: none;background: none;" type="button" class="ropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                                            <span class="fa fa-ellipsis-v text-dark fs-1 ps-2"></span>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li><a class="dropdown-item" href="{% url 'edit_party' i.id %}">Edit</a></li>
                                                            <li><a class="dropdown-item" href="{% url 'deleteparty' i.id %}">Delete</a></li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </form>
                        </div>
                        {% else %}
                        <div class="text-center mt-2">
                            <small>Currently no items are available</small>
                        </div>
                        {% endif %}
                    </div>
                   
                </div>
            </div>
        </div>
        <div class="col-sm-12 col-lg-9  ps-2 pe-3" style="height: 80%;">
            <div id="item_get_detail_target">
                <div class="row m-0" style="height:20%">
                    {% for message in messages %}
                        <div class="alert alert-danger" role="alert">{{ message }}</div>
                    {% endfor %}
                    <div class="card bg-light bs p-3 mb-3">
                        <div class="d-flex justify-content-between">
                            <p class="tb fw-bolder fs-4">{{ getparty.party_name|upper }} </p>
                        </div>
                        <p></p>
                        <div class="d-flex justify-content-between">
                            <p class="tb fw-bolder fs-2">PHONE:  <span class="ps-2 tg">
                                {% if getparty.contact %}
                                    <label for="" style="color: #000000; ">{{ getparty.contact }}</label>
                                {% else %}
                                <a href="{% url 'edit_party' getparty.id %}"><i class="fa fa-phone "></i>&nbsp;&nbsp;Add
                                    Contact</a>
                                {% endif %}</span>
                            </p>
                            <p class="tb fw-bolder fs-2">ADDRESS:  <span class="ps-2 tg">
                                {% if getparty.address %}
                                <label for="" style="color: #000000; ">{{ getparty.address }}</label>
                                {% else %}
                                <a href="{% url 'edit_party' getparty.id %}"><i class="fa fa-map-marker"></i>&nbsp;&nbsp;Add
                                    Address</a>
                                {% endif %}</span>
                            </p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <p class="tb fw-bolder fs-2">EMAIL:  <span class="ps-2 tg">
                                {% if getparty.email %}
                                <label for="" style="color: #000000; ">{{ getparty.email}}</label>
                                {% else %}
                                <a href="{% url 'edit_party' getparty.id %}"><i class="fa fa-envelope"></i>&nbsp;&nbsp;Add
                                    Email</a>
                                {% endif %}</span></p>
                            <p class="tb fw-bolder fs-2">GSTIN:  <span class="ps-2 tg">
                                {% if getparty.gst_no %}
                                <label for="" style="color: #000000; ">{{ getparty.gst_no}}</label>
                                {% else %}
                                <a href="{% url 'edit_party' getparty.id %}"><i class="fa fa-barcode "></i>&nbsp;&nbsp;Add
                                    Gstin</a>
                                {% endif %}
                            </span></p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <p class="tb fw-bolder fs-2">CREDIT LIMIT:  <span class="ps-2 tg">
                                {% if getparty.creditlimit %}
                                <label for="" style="color: #000000; ">{{ getparty.creditlimit}}</label>
                                {% else %}
                                <a href="{% url 'edit_party' getparty.id %}" ><i
                                        class="fas fa-rupee-sign "></i>&nbsp;&nbsp;Set Credit Limit</a>
                                {% endif %}</span></p>
                            <p class="tb fw-bolder fs-2" >BALANCE:  <span class="ps-2 tg" style="color: {% if getparty.payment == 'To Pay' %}red{% elif getparty.payment == 'To Receive' %}green{% else %}black{% endif %};">
                                {{ getparty.current_balance}}
                            </span></p>
                        </div>
                    </div>
                </div>
                <div class="row pt-0 m-0" {% if first_item.item_min_stock_maintain %} style="height:39rem;"{% else %}style="height:41.1rem;"{% endif %}>
                    <div class="card p-0 bg-light bs">
                        <div class="row m-0 p-0 pt-3">
                            <div class="col-sm-12 col-lg-3">
                                <p class="tb fw-bolder pt-2">TRANSACTIONS</p>
                            </div>
                            <div class="col-sm-12 col-lg-3">
                                
                            </div>
                            
                            <div class="col-sm-12 col-lg-6 pt-1">
                                <div class="position-relative">
                                    <div class="position-absolute" style="margin-top:0.4rem;margin-left: 0.5rem;">
                                        <span class="fa fa-search fs-5 text-info"></span>
                                    </div>
                                </div>
                                <div class="d-flex">
                                    <input id="search_input1" style="padding-inline-start: 2rem;" class="w-100 border-secondary text-dark pt-1 pb-1 pe-1 rounded" type="text" placeholder=" search here..">
                                    <button class="btn p-0 ps-2 pe-2 ms-2" type="button" onclick="exportToExcel()">
                                        <span>
                                            <img width="28px" src="{% static 'assets/excel2.png' %}" alt="no img">
                                        </span>
                                    </button>

                                    <button class="btn p-0 ps-2 pe-2 ms-2" type="button" onclick="printfunction()">
                                        <span><img width="30px" src="{% static 'images/printer.jpeg' %}" alt="no img"></span>
                                        <!-- <br><span style="color: black; font-size: small; font-weight: bold;">Print</span> -->
                                    </button>
                                </div>
                            </div>
                                <div class="mt-3" style="overflow: scroll;height: 31rem; ">
                                    <table id="myTable" class="table table-bordered table-info table-striped tb table-responsive w-100">
                                        <thead fs-1 tb>
                                            <th class="text-center fs-2 bg-secondary text-dark extra">#</th>
                                            <th class="text-center fs-2 bg-secondary text-dark extra">TYPE <span class="fa fa-filter fs-1 mx-1"></span></th>
                                            <th class="text-center fs-2 bg-secondary text-dark extra">NUMBER <span class="fa fa-filter fs-1 mx-1"></span></th>
                                            <th class="text-center fs-2 bg-secondary text-dark extra">DATE <span class="fa fa-filter fs-1 mx-1"></span></th>
                                            <th class="text-center fs-2 bg-secondary text-dark extra">TOTAL <span class="fa fa-filter fs-1 mx-1"></span></th>
                                            <th class="text-center fs-2 bg-secondary text-dark extra">BALANCE <span class="fa fa-filter fs-1 mx-1"></span></th>
                                            <th class="text-center fs-2 bg-secondary text-dark extra">ACTION <span class="fa fa-filter fs-1 mx-1"></span></th>
                                            <th class="text-center fs-2 bg-secondary text-dark extra">BY <span class="fa fa-filter fs-1 mx-1"></span></th>
                                            <th class="text-center fs-2 bg-secondary text-dark extra"></th> 
                                        </thead>
                                        <tbody>
                                            <tr {% if getparty.openingbalance == 0 %} hidden{% endif %}>
                                                <td style="font-size: 20px; color: {% if getparty.payment == 'To Pay' %}red{% elif getparty.payment == 'To Receive' %}green{% else %}black{% endif %}; vertical-align: middle;">&#8226;</td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;">Opening Balance</td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;"></td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;">{{ getparty.current_date|date:"d-m-Y" }}</td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;">₹ {{ getparty.openingbalance }}</td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;">₹ {{ getparty.current_balance }}</td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;"></td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;"></td>
                                                <td class="px-0 pt-3 m-0 text-center extra" style="white-space: nowrap;">
                                                    <div class="btn-group mb-1">
                                                        <button style="border: none;background: none;" type="button" class="ropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                                            <span class="fa fa-ellipsis-v text-dark fs-1 ps-"></span>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                          <li><a class="dropdown-item fw-bold tb hide_table_text_v" href="{% url 'edit_party' getparty.id %}"><span class="fa fa-eye pe-2 tg"></span> View / Edit</a></li>
                                                          <li><a class="dropdown-item fw-bold tb hide_table_text_v" href="{% url 'party_histories' getparty.id %}"><span class="fa fa-history pe-2 th"></span> History</a></li>
                                                          <li><a class="dropdown-item fw-bold tb hide_table_text_d"  href="{% url 'deleteparty' getparty.id %}"><span class="fa fa-trash-alt tr" style="padding-inline-start: 0.1rem;padding-inline-end:0.7rem ;"></span> Delete</a></li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% for bill in bills %}
                                            <tr id="billrow">
                                                <td style="font-size: 20px; color: brown; vertical-align: middle;">
                                                    &#8226;
                                                </td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;">Purchase Bill</td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;">{{ bill.billno }}</td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;">{{ bill.billdate|date:"d-m-Y" }}</td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;">₹ {{ bill.grandtotal }}</td>
                                                <td class="text-center extra px-0" style="white-space: nowrap;">₹ {{ bill.balance }}</td>
                                                
                                                <td class="text-center extra px-0" style="white-space: nowrap;">
                                                    {% with filtered_action=bill_history|last_item_for_bill:bill %}
                                                        {% if filtered_action.0 %}
                                                            {{ filtered_action.0 }}
                                                        {% endif %}
                                                    {% endwith %}
                                                </td>
                                                <!-- <td></td> -->
                                                <td class="text-center extra px-0" style="white-space: nowrap;">
                                                    {% with filtered_action=bill_history|last_item_for_bill:bill %}
                                                        {% if filtered_action.1 %}
                                                            {{ filtered_action.1 }}
                                                        {% endif %}
                                                    {% endwith %}
                                                </td>
                                                <td class="px-0 pt-3 m-0 text-center extra" style="white-space: nowrap;">
                                                    <div class="btn-group mb-1">
                                                        <button style="border: none;background: none;" type="button" class="ropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                                            <span class="fa fa-ellipsis-v text-dark fs-1 ps-"></span>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                          <li><a class="dropdown-item fw-bold tb hide_table_text_v" href="{% url 'edit_purchasebill' bill.id %}"><span class="fa fa-eye pe-2 tg"></span> View / Edit</a></li>
                                                          <li><a class="dropdown-item fw-bold tb hide_table_text_v" href="{% url 'history_purchasebill' bill.id %}"><span class="fa fa-history pe-2 th"></span> History</a></li>
                                                          <li><a class="dropdown-item fw-bold tb hide_table_text_d"  href="{% url 'delete_purchasebill' bill.id %}"><span class="fa fa-trash-alt tr" style="padding-inline-start: 0.1rem;padding-inline-end:0.7rem ;"></span> Delete</a></li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="body-wrapper ">
    <br><br>

<div class="p-5 text-center" style="display: flex;justify-content: center;" id="default">
    <div class="card"
        style="background-color: white;width:60rem;box-shadow: 5px 5px 10px 5px rgba(0, 0, 0, 0.249);">
        <div class="row">
            <div class="col-sm-12 col-md-6">
                <img height="500vw" src="{% static 'images/party.jpg' %}" id="img" class="card-img" alt="no img" style="border-radius: 10px 0px 0px 10px;">
                <!-- <div class="card-img-overlay">
                                <h5 class="card-title">Card title</h5>
                                <p class="card-text">This is a wider card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>
                                <p class="card-text"><small>Last updated 3 mins ago</small></p>
                            </div> -->
            </div>
            <div class="col-sm-12 col-md-6 ps-3 pe-4">
                <div class="p-1 rounded" style="border: 1px solid rgba(0, 0, 0, 0);border-bottom: none;">
                    <p style="margin-bottom: 4rem;"></p>
                    <div class="d-flex" style="padding-left: 130px;">
                        <img src="{% static 'assets/images/logos/favicon.png' %}"  width="30" height="30" alt="" />
                        <h3 style="font-family: 'Times New Roman', Times, serif; "><b class="p-3">VYAPAR</b></h3>
                    </div>
                    <!-- <h5 class="card-title">Card title</h5> -->
                    <p style="margin-bottom: 0.5rem;"></p>
                    <p class="card-text p-5" id="text" style=" text-align: justify;font-family: 'Times New Roman', Times, serif;font-weight: bold;font-size: 16px;">Welcome to vyapar, We're committed to providing a seamless and secure
                        online marketplace for buyers and sellers. Our platform offers a range of features.</p>
                    <h5 style="color: rgb(48, 111, 56);font-weight: bold;font-family: 'Times New Roman', Times, serif;" class="card-text">Please Create Your first
                        Expense</h5>
                    <p class="mt-4"></p>
                    <a class="btn btn-lg btn-primary btn-gradient" style="font-weight: bold; font-size: 15px ;" href="{% url 'add_parties' %}">ADD PARTY</a>
                    <p style="margin-bottom: 4rem;"></p>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- <div class="body-wrapper ">
    <br><br><br>
    <div class="p-5 text-center" style="display: flex;justify-content: center;">
        <div class="card "
            style="background-color: white;width:50rem;box-shadow: 5px 5px 10px 5px rgba(0, 0, 0, 0.249);">
            <div class="row">
                <div class="col-sm-12 col-md-6">
                    <img height="500vw" src="{% static 'images/party.png' %}" class="card-img" alt="no img">
                    <div class="card-img-overlay">
                                    <h5 class="card-title">Card title</h5>
                                    <p class="card-text">This is a wider card with supporting text below as a natural lead-in to additional content. This content is a little bit longer.</p>
                                    <p class="card-text"><small>Last updated 3 mins ago</small></p>
                                </div> 
                </div>
                <div class="col-sm-12 col-md-6 ps-4 pe-4">
                    <div class="p-1 rounded" style="border: 1px solid rgba(0, 0, 0, 0);border-bottom: none;">
                        <p style="margin-bottom: 4rem;"></p>
                        <img width="100vw" src="{{'static/images/fav.png'}}" alt="no img">
                        <p></p>
                        <h1 style="font-weight:900;color:rgba(0, 0, 0, 0.644);font-size: 1.5rem;">VYAPAR</h1>
                        <p style="margin-bottom: 1.5rem;"></p>
                        <p class="card-text">Welcome to vyapar, We're committed to providing a seamless and secure
                            online marketplace for buyers and sellers. Our platform offers a range of features.</p>
                        <p style="color: rgb(0, 89, 10);font-weight: light;" class="card-text">Please add your first
                            party</p>
                        <p class="mt-4"></p>
                        <a class="btn btn-lg btn-info btn-gradient" href="{% url 'add_parties' %}">Add Party</a>
                        <p style="margin-bottom: 4rem;"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<p>No parties available.</p> -->
{% endif %}
 
<script>
   
    function exportToExcel() {
        $('.hide_table_text_v').text('')
        $('.hide_table_text_d').text('')
        const table = document.getElementById('myTable');
        const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
        XLSX.writeFile(wb, "table_data.xlsx");
        $('.hide_table_text_v').html('<span class="fa fa-eye pe-2 tg"></span> View / Edit')
        $('.hide_table_text_d').html('<span class="fa fa-trash-alt tr" style="padding-inline-start: 0.1rem;padding-inline-end:0.7rem ;"></span> Delete')
    }
    $(document).ready(function() {
        $("#search_input1").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#myTable tbody tr").filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value)>-1);
            });
        });
    });
    $(document).ready(function(){
        $('#search_item').click(function(){
            $(this).attr('hidden',true)
            $('#search_party_input').attr('hidden',false)
            $('#close_seacrh').attr('hidden',false)
            $('#add_party_btn').attr('hidden',true)
        })
    })
    $(document).ready(function(){
        $('#close_seacrh').click(function(){
            $('#search_party_input').val('')
            $('#search_party_input').attr('hidden',true)
            $('#search_item').attr('hidden',false)
            $('#add_party_btn').attr('hidden',false)
            $('#close_seacrh').attr('hidden',true)
        })
    })
    $(document).ready(function () {
        $("#search_party_input").on("input", function () {
            var searchQuery = $(this).val().toLowerCase();

            $(".item_lists_hide").each(function () {
                var partyName = $(this).find(".fs-2").text().toLowerCase();

                if (partyName.includes(searchQuery) || searchQuery === "") {
                    $(this).show(); // Show the row if it matches or if search input is empty
                } else {
                    $(this).hide(); // Hide the row if it doesn't match
                }
            });
        });

        // Function to handle clearing or closing the search input
        $("#close_seacrh").on("click", function () {
            $("#search_party_input").val(""); // Clear the search input
            $(".item_lists_hide").show(); // Show all parties
        });
    });
    </script>
 
{% endblock  %}
